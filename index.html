<!DOCTYPE html>
<html>
<head>
  <title>Voucher Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: radial-gradient(circle at top, #1a002e, #000);
    padding: 20px;
    color: white;
  }

  .card {
    background: rgba(20, 0, 40, 0.85);
    padding: 25px;
    border-radius: 20px;
    max-width: 420px;
    margin: 20px auto;
    text-align: center;
    box-shadow: 0 0 25px #ff00ff, 0 0 50px #00ffff;
    border: 2px solid #ff00ff;
  }

  h2 {
    color: #ff00ff;
    text-shadow: 0 0 10px #ff00ff, 0 0 20px #00ffff;
    font-size: 24px;
  }

  h3 {
    color: #00ffff;
    text-shadow: 0 0 8px #00ffff;
  }

  button {
    padding: 16px 24px;
    margin-top: 12px;
    border-radius: 14px;
    border: none;
    background: linear-gradient(45deg, #ff00ff, #00ffff);
    color: white;
    cursor: pointer;
    font-weight: bold;
    font-size: 18px;
    box-shadow: 0 0 15px #ff00ff, 0 0 25px #00ffff;
    transition: 0.3s;
    width: 100%; /* full-width for mobile taps */
    max-width: 320px;
  }

  button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 25px #00ffff, 0 0 35px #ff00ff;
  }

  .secondary-btn {
    background: linear-gradient(45deg, #ff0080, #ff4dff);
  }

  input {
    width: 95%;
    padding: 14px;
    margin: 10px 0;
    border-radius: 12px;
    border: 1px solid #00ffff;
    background: #140028;
    color: white;
    outline: none;
    box-shadow: 0 0 12px #00ffff;
    font-size: 16px;
  }

  input::placeholder {
    color: #bbb;
  }

  hr {
    margin: 20px 0;
    border: 1px solid #ff00ff;
    box-shadow: 0 0 10px #ff00ff;
  }

  .order-box {
    border: 1px solid #00ffff;
    padding: 15px;
    margin: 12px 0;
    border-radius: 15px;
    box-shadow: 0 0 12px #00ffff;
    font-size: 16px;
  }

  /* Optional: make images responsive */
  img {
    max-width: 100%;
    height: auto;
  }
</style>

</head>
<body>

<div id="app"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIwwONMemP4WwFE2VZV0lqQhjV_c6pRXM",
  authDomain: "ryujinstore.firebaseapp.com",
  projectId: "ryujinstore",
  storageBucket: "ryujinstore.firebasestorage.app",
  messagingSenderId: "411976248798",
  appId: "1:411976248798:web:e7dc194853cefc7e2f814f"
};


firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= HOME ================= */
function showHomepage() {
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Voucher Store</h2>
      <button onclick="showBuyPage()">Buy Vouchers</button>
      <button onclick="showMyOrder()">Check My Order</button>
      <button onclick="showAdminLogin()" class="secondary-btn">Admin Panel</button>
    </div>
  `;
}

/* ================= BUY ================= */
function showBuyPage() {
  db.ref('voucherInventory').once('value').then(snapshot=>{
    const inventory = snapshot.val() || {};
    const stock70 = inventory['70_percent'] ? Object.keys(inventory['70_percent']).length : 0;
    const stock73 = inventory['73_percent'] ? Object.keys(inventory['73_percent']).length : 0;

    document.getElementById("app").innerHTML = `
      <div class="card">
        <h2>ðŸ’– Buy Vouchers ðŸ’–</h2>

        <p><strong>70% Voucher - â‚±25</strong><br>Available: ${stock70}</p>
        <input type="number" id="qty70" placeholder="Quantity for 70%" min="0" oninput="calculateTotal()">

        <p><strong>73% Voucher - â‚±35</strong><br>Available: ${stock73}</p>
        <input type="number" id="qty73" placeholder="Quantity for 73%" min="0" oninput="calculateTotal()">

        <hr>

        <h3>Total: â‚±<span id="totalAmount">0</span></h3>

        <p><strong>Scan to Pay via GCash</strong></p>

        <img src="https://i.imgur.com/PquwwgW.jpeg"
             alt="GCash QR Code"
             style="width:220px; margin:10px 0; border-radius:12px;">

        <p style="font-size:14px;">
          Please send the exact total amount shown above.
        </p>

        <input type="text" id="reference" placeholder="Enter GCash Reference Number">

        <button onclick="submitOrder()">Submit Order</button>
        <button onclick="showHomepage()" class="secondary-btn">Back</button>

        <div id="buyResult"></div>
      </div>
    `;
  });
}


function submitOrder(){
  const qty70 = parseInt(document.getElementById("qty70").value) || 0;
  const qty73 = parseInt(document.getElementById("qty73").value) || 0;
  const reference = document.getElementById("reference").value.trim();

  if(qty70 === 0 && qty73 === 0) return alert("Enter quantity.");
  if(reference.length < 6) return alert("Invalid reference.");

  const orderRef = db.ref('orders').push();

  orderRef.set({
    qty70,
    qty73,
    reference,
    status: "pending",
    timestamp: Date.now()
  }).then(()=>{
    document.getElementById("buyResult").innerHTML =
      `<p style="color:green;">Order submitted! Await admin confirmation.</p>`;
  });
}

/* ================= ADMIN LOGIN ================= */
function showAdminLogin(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Admin Login</h2>
      <input type="email" id="adminEmail" placeholder="Email">
      <input type="password" id="adminPassword" placeholder="Password">
      <button onclick="adminLogin()">Login</button>
      <button onclick="showHomepage()" class="secondary-btn">Back</button>
      <div id="adminLoginResult"></div>
    </div>
  `;
}

function adminLogin(){
  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();
  firebase.auth().signInWithEmailAndPassword(email,password)
    .then(userCredential=>{
      const user = userCredential.user;
      db.ref("admins/"+user.uid).once("value").then(snapshot=>{
        if(snapshot.exists()){
          showAdminDashboard();
        } else {
          alert("Not authorized.");
          firebase.auth().signOut();
        }
      });
    })
    .catch(err=> alert(err.message));
}

/* ================= ADMIN DASHBOARD ================= */
function showAdminDashboard(){
  db.ref('orders').once('value').then(orderSnap=>{
    const orders = orderSnap.val() || {};

    let html = `
      <div class="card">
        <h2>Admin Panel</h2>

        <button onclick="archiveConfirmed()">ðŸ“¦ Archive Confirmed Orders</button>
        <button onclick="showArchivedOrders()">ðŸ“‚ View Archived Orders</button>

        <hr>

        <h3>Stock Voucher Codes</h3>
        <input type="text" id="stock70" placeholder="Add 70% codes (comma separated)">
        <button onclick="stockCodes('70_percent')">Add 70%</button>

        <input type="text" id="stock73" placeholder="Add 73% codes (comma separated)">
        <button onclick="stockCodes('73_percent')">Add 73%</button>

        <hr>
    `;

    for(const id in orders){
      const o = orders[id];
      html += `
        <div class="order-box">
          <p><b>ID:</b> ${id}</p>
          <p>Qty70: ${o.qty70 || 0}</p>
          <p>Qty73: ${o.qty73 || 0}</p>
          <p>Status: ${o.status}</p>
      `;

      if(o.status === "pending"){
        html += `<button onclick="confirmOrder('${id}', ${o.qty70}, ${o.qty73})">Confirm</button>`;
      }

      if(o.status === "confirmed"){
        const assigned70 = o.vouchersAssigned?.['70_percent'] || [];
        const assigned73 = o.vouchersAssigned?.['73_percent'] || [];
        html += `
          <p>70% Codes: ${assigned70.join(", ")}</p>
          <p>73% Codes: ${assigned73.join(", ")}</p>
        `;
      }

      html += `</div>`;
    }

    html += `<button onclick="showHomepage()" class="secondary-btn">Back</button></div>`;
    document.getElementById("app").innerHTML = html;
  });
}

/* ================= STOCK ================= */
function stockCodes(type){
  const inputId = type === '70_percent' ? "stock70" : "stock73";
  const raw = document.getElementById(inputId).value.trim();
  if(!raw) return alert("Enter codes.");

  const codes = raw.split(",").map(c=>c.trim()).filter(c=>c);
  const updates = {};
  codes.forEach(code=>{
    updates['voucherInventory/'+type+'/'+code] = true;
  });

  db.ref().update(updates).then(()=>{
    alert("Codes added.");
    document.getElementById(inputId).value="";
  });
}

/* ================= CONFIRM ORDER ================= */
function confirmOrder(id, qty70, qty73){
  db.ref('voucherInventory').once('value').then(snapshot=>{
    const inventory = snapshot.val() || {};

    const available70 = inventory['70_percent'] ? Object.keys(inventory['70_percent']) : [];
    const available73 = inventory['73_percent'] ? Object.keys(inventory['73_percent']) : [];

    if(qty70 > available70.length || qty73 > available73.length){
      alert("Not enough stock!");
      return;
    }

    const assigned70 = available70.slice(0, qty70);
    const assigned73 = available73.slice(0, qty73);

    const updates = {};
    updates['orders/'+id+'/status'] = "confirmed";
    updates['orders/'+id+'/vouchersAssigned'] = {
      "70_percent": assigned70,
      "73_percent": assigned73
    };

    assigned70.forEach(code=>{
      updates['voucherInventory/70_percent/'+code] = null;
    });

    assigned73.forEach(code=>{
      updates['voucherInventory/73_percent/'+code] = null;
    });

    db.ref().update(updates).then(()=>{
      alert("Order confirmed & vouchers assigned.");
      showAdminDashboard();
    });
  });
}

  function archiveConfirmed(){
  db.ref('orders').once('value').then(snapshot=>{
    const orders = snapshot.val() || {};
    const updates = {};

    for(const id in orders){
      if(orders[id].status === "confirmed"){
        updates['archivedOrders/' + id] = orders[id];
        updates['orders/' + id] = null;
      }
    }

    db.ref().update(updates).then(()=>{
      alert("Confirmed orders archived.");
      showAdminDashboard();
    });
  });
}
function showArchivedOrders(){
  db.ref('archivedOrders').once('value').then(snapshot=>{
    const orders = snapshot.val() || {};

    let html = `
      <div class="card">
        <h2>Archived Orders</h2>
    `;

    for(const id in orders){
      const o = orders[id];
      html += `
        <div class="order-box">
          <p><b>ID:</b> ${id}</p>
          <p>Status: ${o.status}</p>
          <button onclick="deleteArchived('${id}')">Delete Permanently</button>
        </div>
      `;
    }

    html += `
        <button onclick="showAdminDashboard()">Back</button>
      </div>
    `;

    document.getElementById("app").innerHTML = html;
  });
}

function deleteArchived(id){
  db.ref('archivedOrders/' + id).remove().then(()=>{
    alert("Archived order deleted permanently.");
    showArchivedOrders();
  });
}

  function deleteArchived(id){
  db.ref('archivedOrders/' + id).remove().then(()=>{
    alert("Archived order deleted permanently.");
    showArchivedOrders();
  });
}


/* ================= CHECK ORDER ================= */
function showMyOrder(){
  const reference = prompt("Enter reference:");
  if(!reference) return;

  db.ref('orders').once('value').then(snapshot=>{
    const orders = snapshot.val() || {};
    for(const id in orders){
      const o = orders[id];
      if(o.reference === reference){
        const assigned70 = o.vouchersAssigned?.['70_percent'] || [];
        const assigned73 = o.vouchersAssigned?.['73_percent'] || [];
        document.getElementById("app").innerHTML = `
          <div class="card">
            <h2>My Order</h2>
            <p>Status: ${o.status}</p>
            <p>70% Codes: ${assigned70.join(", ") || "None"}</p>
            <p>73% Codes: ${assigned73.join(", ") || "None"}</p>
            <button onclick="showHomepage()">Back</button>
          </div>
        `;
        return;
      }
    }
    alert("Order not found.");
  });
}

showHomepage();
</script>
</body>
</html>


